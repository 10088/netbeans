# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: NetBeans

on:
  push:
  pull_request:

# cancel other PR workflow run in the same head-base group if it exists (e.g. during PR syncs)
# if this is not a PR run (no github.head_ref and github.base_ref defined), use an UID as group
concurrency: 
  group: ${{ github.head_ref || github.run_id }}-${{ github.base_ref }}
  cancel-in-progress: true

env:
  OPTS: >
    -Dmetabuild.jsonurl=https://raw.githubusercontent.com/apache/netbeans-jenkins-lib/master/meta/netbeansrelease.json
    -Dtest-unit-sys-prop.ignore.random.failures=true

jobs:

# primary build job, most other jobs use the artifact produced here
# artifact is only produced once in the matrix
  base-build:
    name: Build Clusters on JDK ${{ matrix.java }} 
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '11', '17' ]
      fail-fast: false
    steps:
        
      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      - name: Caching dependencies
        uses: actions/cache@v2
        with:
          path: ~/.hgexternalcache
          key: ${{ runner.os }}-${{ hashFiles('*/external/binaries-list', '*/*/external/binaries-list') }}
          restore-keys: ${{ runner.os }}-
          
      - name: Checkout ${{ github.ref }} ( ${{ github.sha }} )
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          submodules: false

      - name: Build NetBeans
        run: ant -quiet -Dcluster.config=release build-nozip

      - name: Prepare Artifact
        if: ${{ matrix.java == '11' }}
        run: tar -I 'zstd -9 -T0' -cf /tmp/build.tar.zst --exclude ".git" .

      - name: Upload Build
        if: ${{ (matrix.java == '11') && success() }}
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: /tmp/build.tar.zst
          retention-days: 1
          if-no-files-found: error


# secondary jobs
  linux-commit-validation:
    name: Commit Validation on Linux/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '8', '11', '17', '19' ]
      fail-fast: false
    steps:

      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      - name: Setup Xvfb
        if: ${{ matrix.java != '20-ea' }}  # see #4299
        run: |
          echo "DISPLAY=:99.0" >> $GITHUB_ENV
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: Commit Validation tests
        run: ant $OPTS -Dcluster.config=release commit-validation

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: "./nbbuild/build/test/commit-validation/results/*.xml"

# the test-summary action above is currently only looking for failures and ignores errors,
# this step can be removed as soon this is fixed upstream
      - name: Upload Test Results
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: validation-log-linux-${{ matrix.java }}
          path: /home/runner/work/netbeans/netbeans/nbbuild/build/test/commit-validation/results/
          retention-days: 1


  paperwork:
    name: Check Paperwork on Linux/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    env:
      ANT_OPTS: -Dmetabuild.jsonurl=https://raw.githubusercontent.com/apache/netbeans-jenkins-lib/master/meta/netbeansrelease.json
    strategy:
      matrix:
        java: [ '11' ]
    steps:

      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      - name: Checkout ${{ github.ref }} ( ${{ github.sha }} )
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          submodules: false
          fetch-depth: 10

      - name: Print last 10 Commits
        if: github.event_name == 'pull_request'
        run: git log --oneline -n10 --pretty=format:'%h %an [%ae] %s'

      - name: Check line endings and verify RAT report
        if: success() || failure()
        run: |
          nbbuild/travis/check-line-endings.sh
          ant -quiet build-source-config
          mkdir scratch && cd scratch
          unzip -qq ../nbbuild/build/release-src*
          ant $OPTS -quiet rat -Drat-report.haltonfailure=true

      - name: Clean Workspace
        if: success() || failure()
        run: cd ..; rm -Rf netbeans; mkdir netbeans

      - name: Download Build
        if: success() || failure()
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        if: success() || failure()
        run: tar --zstd -xf build.tar.zst

      - name: Verify libs and licenses
        if: success() || failure()
        run: ant $OPTS verify-libs-and-licenses -Dverify-libs-and-licenses.haltonfailure=true

      - name: Run check-sigtests-release
        if: success() || failure()
        run: ant $OPTS -quiet check-sigtests-release -Dfail.on.error=true

      - name: Run gen-sigtests-release
        if: success() || failure()
        run: ant $OPTS -quiet gen-sigtests-release


  build-system-test:
    name: Build-System Test on Linux/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '11' ]
    steps:

      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: Test Netbeans Build System
        run: ant $OPTS -Dcluster.config=release localtest


  build-nbms:
    name: Build NBMs, Source zips and Javadoc on JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '11' ]
    steps:

      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: Build nbms
        run: ant $OPTS build-nbms

      - name: Build source zips
        run: ant $OPTS build-source-zips

      - name: Build javadoc
        run: ant $OPTS build-javadoc


  ide-modules-test:
    name: IDE Modules on Linux/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '8' ]
    steps:

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }}
          distribution: 'zulu'

      - name: Setup Xvfb
        run: |
          echo "DISPLAY=:99.0" >> $GITHUB_ENV
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: ide/api.xml
        run: ant $OPTS -f ide/api.xml test

      - name: ide/api.xml.ui
        run: ant $OPTS -f ide/api.xml.ui test

      - name: ide/bugtracking
        run: .github/retry.sh ant $OPTS -f ide/bugtracking test

      - name: ide/bugtracking.bridge
        run: .github/retry.sh ant $OPTS -f ide/bugtracking.bridge test

      - name: ide/bugtracking.commons
        run: ant $OPTS -f ide/bugtracking.commons test

#      - name: ide/bugzilla
#        run: ant $OPTS -f ide/bugzilla test

      - name: ide/code.analysis
        run: ant $OPTS -f ide/code.analysis test

      - name: ide/core.ide
        run: ant $OPTS -f ide/core.ide test

      - name: ide/csl.api
        run: ant $OPTS -f ide/csl.api test

      - name: ide/csl.types
        run: ant $OPTS -f ide/csl.types test

      - name: ide/css.editor
        run: ant $OPTS -f ide/css.editor test

      - name: ide/css.lib
        run: ant $OPTS -f ide/css.lib test

      - name: ide/css.model
        run: ant $OPTS -f ide/css.model test

      - name: ide/db
        run: .github/retry.sh ant $OPTS -f ide/db test

      - name: ide/db.dataview
        run: ant $OPTS -f ide/db.dataview test

      - name: ide/db.sql.editor
        run: ant $OPTS -f ide/db.sql.editor test

      - name: ide/docker.api
        run: ant $OPTS -f ide/docker.api test

      - name: ide/docker.ui
        run: ant $OPTS -f ide/docker.ui test

      - name: ide/editor.bookmarks
        run: ant $OPTS -f ide/editor.bookmarks test

#      - name: ide/editor.bracesmatching
#        run: ant $OPTS -f ide/editor.bracesmatching test

      - name: ide/editor.document
        run: ant $OPTS -f ide/editor.document test

      - name: ide/editor.fold
        run: ant $OPTS -f ide/editor.fold test

      - name: ide/editor.fold.nbui
        run: ant $OPTS -f ide/editor.fold.nbui test

      - name: ide/editor.guards
        run: ant $OPTS -f ide/editor.guards test

      - name: ide/editor.indent
        run: ant $OPTS -f ide/editor.indent test

      - name: ide/editor.indent.project
        run: ant $OPTS -f ide/editor.indent.project test

      - name: ide/editor.macros
        run: ant $OPTS -f ide/editor.macros test

      - name: ide/editor.search
        run: ant $OPTS -f ide/editor.search test

      - name: ide/editor.settings
        run: ant $OPTS -f ide/editor.settings test

      - name: ide/editor.settings.storage
        run: .github/retry.sh ant $OPTS -f ide/editor.settings.storage test

      - name: ide/editor.structure
        run: ant $OPTS -f ide/editor.structure test

      - name: ide/editor.tools.storage
        run: ant $OPTS -f ide/editor.tools.storage test

      - name: ide/editor.util
        run: ant $OPTS -f ide/editor.util test

      - name: ide/extbrowser
        run: ant $OPTS -f ide/extbrowser test

      - name: ide/extexecution.base
        run: ant $OPTS -f ide/extexecution.base test

      - name: ide/gsf.testrunner.ui
        run: ant $OPTS -f ide/gsf.testrunner.ui test

      - name: ide/html
        run: .github/retry.sh ant $OPTS -f ide/html test

      - name: ide/html.custom
        run: ant $OPTS -f ide/html.custom test

#      - name: ide/html.editor
#        run: ant $OPTS -f ide/html.editor test

#      - name: ide/html.lexer
#        run: ant $OPTS -f ide/html.lexer test

      - name: ide/html.parser
        run: ant $OPTS -f ide/html.parser test

      - name: ide/html.validation
        run: ant $OPTS -f ide/html.validation test

      - name: ide/hudson
        run: ant $OPTS -f ide/hudson test

      - name: ide/hudson.git
        run: ant $OPTS -f ide/hudson.git test

      - name: ide/hudson.mercurial
        run: ant $OPTS -f ide/hudson.mercurial test

      - name: ide/hudson.subversion
        run: ant $OPTS -f ide/hudson.subversion test

      - name: ide/hudson.tasklist
        run: ant $OPTS -f ide/hudson.tasklist test

      - name: ide/hudson.ui
        run: ant $OPTS -f ide/hudson.ui test

      - name: ide/javascript2.debug
        run: ant $OPTS -f ide/javascript2.debug test

      - name: ide/languages.toml
        run: ant $OPTS -f ide/languages.toml test

      - name: ide/languages.yaml
        run: ant $OPTS -f ide/languages.yaml test

      - name: ide/lexer
        run: ant $OPTS -f ide/lexer test

      - name: ide/lib.terminalemulator
        run: ant $OPTS -f ide/lib.terminalemulator test

      - name: ide/libs.freemarker
        run: ant $OPTS -f ide/libs.freemarker test

#      - name: ide/libs.git
#        run: ant $OPTS -f ide/libs.git test

      - name: ide/libs.graalsdk
        run: ant $OPTS -f ide/libs.graalsdk test

#      - name: ide/localhistory
#        run: ant $OPTS -f ide/localhistory test

      - name: ide/libs.truffleapi
        run: ant $OPTS -f ide/libs.truffleapi test

      - name: ide/lsp.client
        run: ant $OPTS -f ide/lsp.client test

      - name: ide/notifications
        run: ant $OPTS -f ide/notifications test

      - name: ide/o.openidex.util
        run: ant $OPTS -f ide/o.openidex.util test

#      - name: ide/parsing.api
#        run: ant $OPTS -f ide/parsing.api test

#      - name: ide/parsing.indexing
#        run: ant $OPTS -f ide/parsing.indexing test

      - name: ide/parsing.lucene
        run: ant $OPTS -f ide/parsing.lucene test

      - name: ide/project.ant
        run: ant $OPTS -f ide/project.ant test

      - name: ide/project.ant.compat8
        run: ant $OPTS -f ide/project.ant.compat8 test

      - name: ide/project.ant.ui
        run: ant $OPTS -f ide/project.ant.ui test

      - name: ide/project.libraries
        run: ant $OPTS -f ide/project.libraries test

      - name: ide/project.libraries.ui
        run: ant $OPTS -f ide/project.libraries.ui test

      - name: ide/projectapi
        run: ant $OPTS -f ide/projectapi test

      - name: ide/projectapi.nb
        run: ant $OPTS -f ide/projectapi.nb test

      - name: ide/projectuiapi.base
        run: ant $OPTS -f ide/projectuiapi.base test

      - name: ide/refactoring.api
        run: ant $OPTS -f ide/refactoring.api test

      - name: ide/schema2beans
        run: ant $OPTS -f ide/schema2beans test

      - name: ide/server
        run: ant $OPTS -f ide/server test

      - name: ide/spellchecker
        run: ant $OPTS -f ide/spellchecker test

      - name: ide/spi.editor.hints
        run: ant $OPTS -f ide/spi.editor.hints test

#      - name: ide/spi.palette
#        run: ant $OPTS -f ide/spi.palette test

      - name: ide/spi.tasklist
        run: ant $OPTS -f ide/spi.tasklist test

      - name: ide/tasklist.ui
        run: ant $OPTS -f ide/tasklist.ui test

      - name: ide/team.commons
        run: ant $OPTS -f ide/team.commons test

      - name: ide/terminal.nb
        run: ant $OPTS -f ide/terminal.nb test

      - name: ide/utilities
        run: ant $OPTS -f ide/utilities test

      - name: ide/versioning.masterfs
        run: ant $OPTS -f ide/versioning.masterfs test

      - name: ide/versioning.ui
        run: ant $OPTS -f ide/versioning.ui test

      - name: ide/versioning.util
        run: ant $OPTS -f ide/versioning.util test

      - name: ide/web.common
        run: ant $OPTS -f ide/web.common test

      - name: ide/web.common.ui
        run: ant $OPTS -f ide/web.common.ui test

      - name: ide/web.webkit.debugging
        run: ant $OPTS -f ide/web.webkit.debugging test

      - name: ide/xml
        run: ant $OPTS -f ide/xml test

      - name: ide/xml.axi
        run: ant $OPTS -f ide/xml.axi test

      - name: ide/xml.catalog
        run: ant $OPTS -f ide/xml.catalog test-unit

      - name: ide/xml.core
        run: ant $OPTS -f ide/xml.core test

      - name: ide/xml.lexer
        run: ant $OPTS -f ide/xml.lexer test

      - name: ide/xml.multiview
        run: ant $OPTS -f ide/xml.multiview test

      - name: ide/xml.retriever
        run: ant $OPTS -f ide/xml.retriever test

      - name: ide/xml.schema.completion
        run: ant $OPTS -f ide/xml.schema.completion test

      - name: ide/xml.schema.model
        run: ant $OPTS -f ide/xml.schema.model test

      - name: ide/xml.text
        run: ant $OPTS -f ide/xml.text test

      - name: ide/xml.text.obsolete90
        run: ant $OPTS -f ide/xml.text.obsolete90 test

      - name: ide/xml.wsdl.model
        run: .github/retry.sh ant $OPTS -f ide/xml.wsdl.model test

      - name: ide/xml.xam
        run: ant $OPTS -f ide/xml.xam test

      - name: ide/xml.xdm
        run: ant $OPTS -f ide/xml.xdm test

      - name: ide/xsl
        run: ant $OPTS -f ide/xsl test

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: "./*/*/build/test/*/results/TEST-*.xml"


  java-modules-test:
    name: Java Modules on Linux/JDK ${{ matrix.java }} (some on 11)
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '8' ]
    steps:

      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      - name: Setup Xvfb
        run: |
          echo "DISPLAY=:99.0" >> $GITHUB_ENV
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

#      - name: java/ant.debugger
#        run: ant $OPTS -f java/ant.debugger test

      - name: ant.freeform
        run: ant $OPTS -f java/ant.freeform test

#      - name: java/ant.grammar
#        run: ant $OPTS -f java/ant.grammar test

      - name: api.debugger.jpda
        run: ant $OPTS -f java/api.debugger.jpda test

      - name: api.java
        run: ant $OPTS -f java/api.java test

      - name: api.maven
        run: ant $OPTS -f java/api.maven test

#      - name: beans
#        run: ant $OPTS -f java/beans test

      - name: classfile
        run: ant $OPTS -f java/classfile test

      - name: dbschema
        run: ant $OPTS -f java/dbschema test -Dtest.config=stable

#      - name: debugger.jpda
#        run: ant $OPTS -f java/debugger.jpda test

      - name: debugger.jpda.js
        run: ant $OPTS -f java/debugger.jpda.js test

      - name: debugger.jpda.projects
        run: ant $OPTS -f java/debugger.jpda.projects test

      - name: debugger.jpda.projectsui
        run: ant $OPTS -f java/debugger.jpda.projectsui test

#      - name: debugger.jpda.truffle
#        run: ant $OPTS -f java/debugger.jpda.truffle test

#      - name: debugger.jpda.ui
#        run: ant $OPTS -f java/debugger.jpda.ui test

      - name: editor.htmlui
        run: ant $OPTS -f java/editor.htmlui test

#      - name: java/form
#        run: ant $OPTS -f java/form test

      - name: hudson.maven
        run: ant $OPTS -f java/hudson.maven test

      - name: java.completion
        run: ant $OPTS -f java/java.completion test

      - name: java.freeform
        run: ant $OPTS -f java/java.freeform test

#      - name: java.kit
#        run: ant $OPTS -f java/java.kit test

#      - name: java.lexer
#        run: ant $OPTS -f java/java.lexer test

#      - name: java.metrics
#        run: ant $OPTS -f java/java.metrics test

      - name: java.module.graph
        run: ant $OPTS -f java/java.module.graph test

      - name: java.navigation
        run: ant $OPTS -f java/java.navigation test

#      - name: java.openjdk.project
#        run: ant $OPTS -f java/java.openjdk.project test

      - name: java.mx.project
        run: .github/retry.sh ant $OPTS -f java/java.mx.project test

      - name: java.platform
        run: ant $OPTS -f java/java.platform test

      - name: java.platform.ui
        run: ant $OPTS -f java/java.platform.ui test

      - name: java.preprocessorbridge
        run: ant $OPTS -f java/java.preprocessorbridge test

      - name: java.project
        run: ant $OPTS -f java/java.project test

#      - name: java.project.ui
#        run: ant $OPTS -f java/java.project.ui test

      - name: java.source
        run: ant $OPTS -f java/java.source test-unit

#      - name: java.source.ant
#        run: ant $OPTS -f java/java.source.ant test

      - name: java.source.base
        run: ant $OPTS -f java/java.source.base test

      - name: java.source.compat8
        run: ant $OPTS -f java/java.source.compat8 test

      - name: java.source.queriesimpl
        run: ant $OPTS -f java/java.source.queriesimpl test

#      - name: java.sourceui
#        run: ant $OPTS -f java/java.sourceui test

      - name: java.testrunner
        run: ant $OPTS -f java/java.testrunner test

      - name: java.testrunner.ant
        run: ant $OPTS -f java/java.testrunner.ant test

#      - name: javadoc
#        run: ant $OPTS -f java/javadoc test

#      - name: javawebstart
#        run: ant $OPTS -f java/javawebstart test

#      - name: jellytools.java
#        run: ant $OPTS -f java/jellytools.java test

#      - name: jshell.support
#        run: ant $OPTS -f java/jshell.support test

#      - name: junit
#        run: ant $OPTS -f java/junit test

      - name: junit.ant.ui
        run: ant $OPTS -f java/junit.ant.ui test

      - name: lib.nbjavac
        run: ant $OPTS -f java/lib.nbjavac test

      - name: maven
        run: ant $OPTS -f java/maven test

      - name: maven.embedder
        run: ant $OPTS -f java/maven.embedder test

      - name: maven.grammar
        run: ant $OPTS -f java/maven.grammar test

#      - name: maven.hints
#        run: ant $OPTS -f java/maven.hints test

#      - name: maven.htmlui
#        run: ant $OPTS -f java/maven.htmlui test

      - name: maven.indexer
        run: ant $OPTS -f java/maven.indexer test

      - name: maven.junit
        run: ant $OPTS -f java/maven.junit test

      - name: maven.model
        run: ant $OPTS -f java/maven.model test

      - name: maven.osgi
        run: ant $OPTS -f java/maven.osgi test

#      - name: performance
#        run: ant $OPTS -f java/performance test

#      - name: performance.java
#        run: ant $OPTS -f java/performance.java test

#      - name: projectimport.eclipse.core
#        run: ant $OPTS -f java/projectimport.eclipse.core test

#      - name: refactoring.java
#        run: ant $OPTS -f refactoring.java test

      - name: spellchecker.bindings.java
        run: ant $OPTS -f java/spellchecker.bindings.java test

#      - name: spi.java.hints
#        run: ant $OPTS -f java/spi.java.hints test

      - name: spring.beans
        run: ant $OPTS -f java/spring.beans test

      - name: testng
        run: ant $OPTS -f java/testng test

#      - name: testng.ant
#        run: ant $OPTS -f java/testng.ant test

#      - name: testng.ui
#        run: ant $OPTS -f java/testng.ui test

      - name: whitelist
        run: ant $OPTS -f java/whitelist test

      - name: xml.jaxb
        run: ant $OPTS -f java/xml.jaxb test

      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: 'zulu'

      - name: Set up opts
        run: echo "OPTS_11=-Dtest.run.args=--limit-modules=java.base,java.logging,java.xml,java.prefs,java.desktop,java.management,java.instrument,jdk.zipfs,java.scripting,java.naming -Dtest.bootclasspath.prepend.args=-Dno.netbeans.bootclasspath.prepend.needed=true" >> $GITHUB_ENV

      - name: java/java.completion
        run: ant $OPTS $OPTS_11 -f java/java.completion test

      - name: java/java.source
        run: ant $OPTS $OPTS_11 -f java/java.source test-unit

      - name: java/java.source.base
        run: .github/retry.sh ant $OPTS $OPTS_11 -f java/java.source.base test

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: "./*/*/build/test/*/results/TEST-*.xml"


  apisupport-modules-test:
    name: APISupport Modules on Linux/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '8' ]
    steps:

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }}
          distribution: 'zulu'

      - name: Setup Xvfb
        run: |
          echo "DISPLAY=:99.0" >> $GITHUB_ENV
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: apisupport.ant
        run: ant $OPTS -f apisupport/apisupport.ant test

      - name: apisupport.project
        run: ant $OPTS -f apisupport/apisupport.project test

      - name: apisupport.refactoring
        run: ant $OPTS -f apisupport/apisupport.refactoring test

      - name: apisupport.wizards
        run: ant $OPTS -f apisupport/apisupport.wizards test

      - name: maven.apisupport
        run: ant $OPTS -f apisupport/maven.apisupport test

      - name: timers
        run: ant $OPTS -f apisupport/timers test -Dtest.config=stable

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: "./*/*/build/test/*/results/*.xml"


  extide-modules-test:
    name: ExtIDE Modules on Linux/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '11' ]
    steps:

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }}
          distribution: 'zulu'

      - name: Setup Xvfb
        run: |
          echo "DISPLAY=:99.0" >> $GITHUB_ENV
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: o.apache.tools.ant.module
        run: ant $OPTS -f extide/o.apache.tools.ant.module test

      - name: gradle
        run: ant $OPTS -f extide/gradle test

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: "./*/*/build/test/*/results/*.xml"


  java-hints-test:
    name: Java Hints ${{ matrix.config }} on Linux/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '11' ]
        config: [ 'batch1', 'batch2' ]
    steps:

      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      - name: Setup Xvfb
        run: |
          echo "DISPLAY=:99.0" >> $GITHUB_ENV
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: java.hints ${{ matrix.config }}
        run: ant $OPTS -Dtest.config=${{ matrix.config }} -f java/java.hints test

      - name: java.hints.declarative
        if: ${{ (matrix.config == 'batch2') && success() }}
        run: ant $OPTS -f java/java.hints.declarative test

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: "./*/*/build/test/*/results/*.xml"


  profiler-test:
    name: Profiler on Linux/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '11' ]
    steps:

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }}
          distribution: 'zulu'

      - name: Setup Xvfb
        run: |
          echo "DISPLAY=:99.0" >> $GITHUB_ENV
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: profiler
        run: ant $OPTS -f profiler/profiler test-unit

      - name: profiler.oql
        run: ant $OPTS -f profiler/profiler.oql test

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: "./*/*/build/test/*/results/*.xml"


  macos:
    name: Tests on MacOS/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: macos-11
    strategy:
      matrix:
        java: [ '11' ]
    steps:

      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      - uses: actions/cache@v2
        with:
          path: ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-homebrew
          restore-keys: ${{ runner.os }}-homebrew

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      # tar on MacOS is not aware of zstd "tar --zstd -xf build.tar.zst" isn't working
      - name: Extract
        run: unzstd -c build.tar.zst | tar -x

      - run: brew install ant

      - name: Test platform/masterfs.macosx
        run: ant $OPTS -f platform/masterfs.macosx test

      - name: Test platform/core.network
        run: ant $OPTS -f platform/core.network test

      - name: Commit Validation tests
        run: ant $OPTS -Dcluster.config=release commit-validation

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: |
            "./*/*/build/test/*/results/*.xml"
            "./nbbuild/build/test/commit-validation/results/*.xml"


  javafx-test:
    name: JavaFX on Linux/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '11' ]
    steps:

      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      - name: Setup Xvfb
        run: |
          echo "DISPLAY=:99.0" >> $GITHUB_ENV
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: javafx2.editor
        run: ant $OPTS -f javafx/javafx2.editor test -Dtest.config=stable

#      - name: javafx2.project
#        run: ant $OPTS -f javafx/javafx2.project test

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: "./*/*/build/test/*/results/*.xml"


  enterprise-test:
    name: Enterprise on Linux/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [ '8' ]
    steps:

      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      - name: Setup Xvfb
        run: |
          echo "DISPLAY=:99.0" >> $GITHUB_ENV
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: spring.webmvc
        run: ant $OPTS -f enterprise/spring.webmvc test

      - name: websvc.editor.hints
        run: ant $OPTS -f enterprise/websvc.editor.hints test

      - name: websvc.websvcapi
        run: ant $OPTS -f enterprise/websvc.websvcapi test

      - name: websvc.wsstackapi
        run: ant $OPTS -f enterprise/websvc.wsstackapi test

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: "./*/*/build/test/*/results/*.xml"


  php:
    name: PHP on ${{ matrix.os }}/JDK ${{ matrix.java }}
    needs: base-build
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    env:
      DISPLAY: ":99.0"
    strategy:
      matrix:
        java: [ '8' ]
        os: [ 'windows-2022', 'ubuntu-20.04' ]
      fail-fast: false
    steps:

      - name: Set up JDK ${{ matrix.java }} 
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }} 
          distribution: 'zulu'

      # linux specific setup
      - name: Setup PHP
        if: contains(matrix.os, 'ubuntu')
        uses: shivammathur/setup-php@2.8.0
        with:
          php-version: '7.4'
          tools: pecl
          extensions: xdebug
          ini-values: xdebug.mode=debug

      - name: Setup Xvfb
        if: contains(matrix.os, 'ubuntu')
        run: Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
      # - - -

      - name: Download Build
        uses: actions/download-artifact@v3
        with:
          name: build

      - name: Extract
        run: tar --zstd -xf build.tar.zst

      - name: Test Platform Core Network
        run: ant $OPTS -f platform/core.network test

      - name: hudson.php
        run: ant $OPTS -f php/hudson.php test

      - name: languages.neon
        run: ant $OPTS -f php/languages.neon test

      - name: php.api.annotation
        run: ant $OPTS -f php/php.api.annotation test

      - name: php.api.documentation
        run: ant $OPTS -f php/php.api.documentation test

      - name: php.api.executable
        run: ant $OPTS -f php/php.api.executable test

      - name: php.api.framework
        run: ant $OPTS -f php/php.api.framework test

      - name: php.api.phpmodule
        run: ant $OPTS -f php/php.api.phpmodule test

      - name: php.api.testing
        run: ant $OPTS -f php/php.api.testing test

      - name: php.apigen
        run: ant $OPTS -f php/php.apigen test

      - name: php.atoum
        run: ant $OPTS -f php/php.atoum test

      - name: php.code.analysis
        run: ant $OPTS -f php/php.code.analysis test

      - name: php.codeception
        run: ant $OPTS -f php/php.codeception test

      - name: php.composer
        run: ant $OPTS -f php/php.composer test

      # needs X fails on Windows
      - name: php.dbgp
        if: contains(matrix.os, 'ubuntu')
        run: ant $OPTS -f php/php.dbgp test

      - name: php.doctrine2
        run: ant $OPTS -f php/php.doctrine2 test

      # longest step (~40min)
      - name: php.editor
        run: ant $OPTS -f php/php.editor test

      - name: php.latte
        run: ant $OPTS -f php/php.latte test

      - name: php.nette.tester
        run: ant $OPTS -f php/php.nette.tester test

      - name: php.phpunit
        run: ant $OPTS -f php/php.phpunit test

      - name: php.project
        run: ant $OPTS -f php/php.project test

      - name: php.refactoring
        run: ant $OPTS -f php/php.refactoring test

      - name: php.smarty
        run: ant $OPTS -f php/php.smarty test

      - name: php.symfony
        run: ant $OPTS -f php/php.symfony test

      - name: php.symfony2
        run: ant $OPTS -f php/php.symfony2 test

      - name: php.twig
        run: ant $OPTS -f php/php.twig test

      - name: php.zend
        run: ant $OPTS -f php/php.zend test

      - name: php.zend2
        run: ant $OPTS -f php/php.zend2 test

      - name: spellchecker.bindings.php
        run: ant $OPTS -f php/spellchecker.bindings.php test

      - name: Create Test Summary
        uses: test-summary/action@v1
        if: failure()
        with:
          paths: "./*/*/build/test/*/results/*.xml"
 

# last job depends on everything so that it is forced to run last even if a long job fails early
  cleanup:
    name: Cleanup Workflow Artifacts
    needs:
      - base-build
      - linux-commit-validation
      - paperwork
      - build-system-test
      - build-nbms
      - ide-modules-test
      - java-modules-test
      - java-hints-test
      - profiler-test
      - apisupport-modules-test
      - extide-modules-test
      - macos
      - php
      - javafx-test
      - enterprise-test

    # don't cleanup on failure() or always(), because someone might want to restart an unreliable secondary job
    if: ${{ always() && contains(needs.*.result, 'success') && !(contains(needs.*.result, 'failure')) }}
    runs-on: ubuntu-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          submodules: true

      - name: Delete build Artifact
        uses: ./.github/actions/delete-artifact/
        with:
          name: build
          failOnError: true
